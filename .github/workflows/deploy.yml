name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    container: ghcr.io/railwayapp/cli:latest

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: railway up --service shipapi --detach

  smoke-test:
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Wait for deployment to settle
        run: sleep 90

      - name: Run smoke tests
        run: |
          for i in $(seq 1 5); do
            echo "Smoke test attempt $i of 5..."
            if curl -sf https://shipapi.workermill.com/api/v1/health && \
               curl -sf https://shipapi.workermill.com/docs; then
              echo "Smoke tests passed on attempt $i"
              exit 0
            fi
            if [ "$i" -lt 5 ]; then
              echo "Attempt $i failed, waiting 30s before retry..."
              sleep 30
            fi
          done
          echo "Smoke tests failed after 5 attempts"
          exit 1
